name: Deploy to Staging

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: athangict/dmis-stagging-app
      KUBECONFIG: C:\actions-runner\_work\dmis-stagging-app\dmis-stagging-app\kubeconfig

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Install kubectl
        run: choco install kubernetes-cli -y

      - name: Prepare kubeconfig
        shell: pwsh -ExecutionPolicy Bypass
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          $ErrorActionPreference = 'Stop'
          $env:Path = "C:\kubectl;$env:Path"
          
          $secret = $env:KUBE_CONFIG
          $secretLength = $secret.Length
          Write-Host "Secret received length: $secretLength characters"
          
          if ($secretLength -lt 100) {
            Write-Host "‚ùå ERROR: KUBE_CONFIG_SECRET is EMPTY or TOO SHORT!"
            Write-Host ""
            Write-Host "üìù STEPS TO FIX:"
            Write-Host "1. Go to: https://github.com/athangict/dmis-stagging-app/settings/secrets/actions"
            Write-Host "2. Click on 'KUBE_CONFIG_SECRET' to edit"
            Write-Host "3. Delete ALL current content"
            Write-Host "4. Paste the BASE64 string (should be ~9000+ characters)"
            Write-Host "5. Click 'Update secret'"
            Write-Host "6. Wait 5 seconds, then re-run this workflow"
            exit 1
          }
          
          Write-Host "‚úì Secret received: $secretLength characters"
          $bytes = [Convert]::FromBase64String($secret)
          $cfg = "C:\actions-runner\_work\dmis-stagging-app\dmis-stagging-app\kubeconfig"
          [IO.File]::WriteAllBytes($cfg, $bytes)
          
          $FILESIZE = (Get-Item $cfg).Length
          Write-Host "‚úì Kubeconfig file size: $FILESIZE bytes"
          Write-Host "Server endpoint:"
          Select-String -Path $cfg -Pattern "server:" | ForEach-Object { $_.Line }

      - name: Check kubectl version
        shell: pwsh
        run: |
          $env:Path = "C:\kubectl;$env:Path"
          kubectl version --client

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Deploy to Kubernetes
        shell: pwsh -ExecutionPolicy Bypass
        run: |
          $env:Path = "C:\kubectl;$env:Path"
          kubectl apply -f k8s/deployment.yaml
          kubectl rollout status deployment/dmis-stagging-app -n default